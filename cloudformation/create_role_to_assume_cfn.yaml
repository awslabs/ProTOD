# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

AWSTemplateFormatVersion: "2010-09-09"

Description: |
  This template creates an AWS IAM Role with an inline policy and two AWS managed policies
  attached. It sets the trust policy on that IAM Role to permit a named ARN in another AWS
  account to assume that role. The role name and the ARN of the trusted user can all be passed
  to the CloudFormation stack as parameters. Then you can run Prowler to perform a security
  assessment with a command like:
  prowler --role ProwlerScanRole.ARN
Parameters:
  pRoleExternalId:
    Description: |
      Best practices is to use a unique string GUID using uuidgen.
      Allowed characters are: upper and lower case, numbers, and the dash "-".
      This string should be generated by the owner of the target account and provided the consultant.
    Type: String
    MinLength: 10
    MaxLength: 256
    AllowedPattern: "^[a-zA-Z0-9-]*$"
  pRoleExpirationDate:
    Description: |
      Change the default to a future date. This is the day in which the scanning account
      will no longer have access to the target account amd it is expressed as YYYY-MM-DD
    Type: String
    Default: "2020-01-31"
    MinLength: 10
    MaxLength: 10
    AllowedPattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}]*$"
  pAuthorizedARN:
    Description: |
      This is the AWS account that will perform the scan. Do not change.
    Type: String
    Default: "577854458058"
    AllowedValues:
      - "577854458058"
  pProwlerRoleName:
    Description: |
      Name of the IAM role that will have these policies attached.
      You must provide this name to the consultant if you change it.
    Type: String
    Default: "ProwlerExecRole"
    MinLength: 10
    MaxLength: 64
  pCreateProwlerS3Bucket:
    Description: |
      If enabled, this cloudformation stack will create an S3 Bucket to save the Prowler output.
      Remember to remove the file and folder before deleting this CloudFormation Template.
    Type: String
    AllowedValues:
      - "true"
      - "false"
    Default: "false"

Conditions:
  CreateProwlerS3Bucket: !Equals
    - !Ref pCreateProwlerS3Bucket
    - "true"
  NoProwlerS3Bucket: !Equals
    - !Ref pCreateProwlerS3Bucket
    - "false"
Resources:
  # S3 Bucket
  ProwlerBucket:
    Condition: CreateProwlerS3Bucket
    Type: AWS::S3::Bucket
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W35
            reason: "Access logging for this bucket is determined by the owner of the account it is deployed to."
    Properties:
      OwnershipControls:
        Rules:
          - ObjectOwnership: ObjectWriter
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: Rule to expire all objects after 7 days
            Status: Enabled
            ExpirationInDays: 7
      Tags:
        - Key: Name
          Value: ProTOD Output S3 Bucket

  # S3 Bucket Policy to enforce Transport Encryption
  ProwlerBucketPolicy:
    Condition: CreateProwlerS3Bucket
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ProwlerBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action: "s3:*"
            Effect: Deny
            Resource:
              - !Sub "arn:aws:s3:::${ProwlerBucket}/*"
              - !Sub "arn:aws:s3:::${ProwlerBucket}"
            Principal: "*"
            Condition:
              Bool:
                "aws:SecureTransport": false

  # This is deployed if pCreateProwlerS3Bucket is false
  ProwlerExecRole:
    # Check: CKV_AWS_111: "Ensure IAM policies does not allow write access without constraints"
    # checkov:skip=CKV_AWS_111:Using Principal to restrict write access to the bucket.
    Condition: NoProwlerS3Bucket
    Type: AWS::IAM::Role
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "The Prowler scanner is used to scan all AWS resources in the account."
          - id: W28
            reason: "Using explicit names to ensure visibility. OK to replace the role upon update."
          - id: W76
            reason: "Prowler needs access to scan multiple services."
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub ${pAuthorizedARN}
            Action: "sts:AssumeRole"
            Condition:
              DateLessThan:
                "aws:CurrentTime": !Ref pRoleExpirationDate
              StringEquals:
                "sts:ExternalId": !Ref pRoleExternalId
      MaxSessionDuration: 43200
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/SecurityAudit"
        - "arn:aws:iam::aws:policy/job-function/ViewOnlyAccess"
      RoleName: !Sub ${pProwlerRoleName}
      Policies:
        - PolicyName: ProwlerScanRoleAdditionalViewPrivileges
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "account:Get*"
                  - "appstream:Describe*"
                  - "appstream:List*"
                  - "backup:List*"
                  - "cloudtrail:GetInsightSelectors"
                  - "codeartifact:List*"
                  - "codebuild:BatchGet*"
                  - "cognito-idp:GetUserPoolMfaConfig"
                  - "dlm:Get*"
                  - "drs:Describe*"
                  - "ds:Get*"
                  - "ds:Describe*"
                  - "ds:List*"
                  - "dynamodb:GetResourcePolicy"
                  - "ec2:GetEbsEncryptionByDefault"
                  - "ec2:GetSnapshotBlockPublicAccessState"
                  - "ec2:GetInstanceMetadataDefaults"
                  - "ecr:Describe*"
                  - "ecr:GetRegistryScanningConfiguration"
                  - "elasticfilesystem:DescribeBackupPolicy"
                  - "glue:GetConnections"
                  - "glue:GetSecurityConfiguration*"
                  - "glue:SearchTables"
                  - "lambda:GetFunction*"
                  - "logs:FilterLogEvents"
                  - "lightsail:GetRelationalDatabases"
                  - "macie2:GetMacieSession"
                  - "s3:GetAccountPublicAccessBlock"
                  - "shield:DescribeProtection"
                  - "shield:GetSubscriptionState"
                  - "securityhub:BatchImportFindings"
                  - "securityhub:GetFindings"
                  - "ssm:GetDocument"
                  - "ssm-incidents:List*"
                  - "support:Describe*"
                  - "tag:GetTagKeys"
                  - "wellarchitected:List*"
                Resource: "*"
        - PolicyName: ProwlerScanRoleAdditionalViewPrivilegesApiGateway
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "apigateway:GET"
                Resource: "arn:aws:apigateway:*::/restapis/*"
      Tags:
        - Key: Name
          Value: ProTOD Prowler Role

  # This is deployed if pCreateProwlerS3Bucket is true
  ProwlerExecRoleWithS3:
    Condition: CreateProwlerS3Bucket
    Type: AWS::IAM::Role
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "The Prowler scanner is used to scan all AWS resources in the account."
          - id: W28
            reason: "Using explicit names to ensure visibility. OK to replace the role upon update."
          - id: W76
            reason: "Prowler needs access to scan multiple services."
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub ${pAuthorizedARN}
            Action: "sts:AssumeRole"
            Condition:
              DateLessThan:
                "aws:CurrentTime": !Ref pRoleExpirationDate
              StringEquals:
                "sts:ExternalId": !Ref pRoleExternalId
      MaxSessionDuration: 43200
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/SecurityAudit"
        - "arn:aws:iam::aws:policy/job-function/ViewOnlyAccess"
      RoleName: !Sub ${pProwlerRoleName}
      Policies:
        - PolicyName: ProwlerScanRoleAdditionalViewPrivileges
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "account:Get*"
                  - "appstream:Describe*"
                  - "appstream:List*"
                  - "backup:List*"
                  - "cloudtrail:GetInsightSelectors"
                  - "codeartifact:List*"
                  - "codebuild:BatchGet*"
                  - "cognito-idp:GetUserPoolMfaConfig"
                  - "dlm:Get*"
                  - "drs:Describe*"
                  - "ds:Get*"
                  - "ds:Describe*"
                  - "ds:List*"
                  - "dynamodb:GetResourcePolicy"
                  - "ec2:GetEbsEncryptionByDefault"
                  - "ec2:GetSnapshotBlockPublicAccessState"
                  - "ec2:GetInstanceMetadataDefaults"
                  - "ecr:Describe*"
                  - "ecr:GetRegistryScanningConfiguration"
                  - "elasticfilesystem:DescribeBackupPolicy"
                  - "glue:GetConnections"
                  - "glue:GetSecurityConfiguration*"
                  - "glue:SearchTables"
                  - "lambda:GetFunction*"
                  - "logs:FilterLogEvents"
                  - "lightsail:GetRelationalDatabases"
                  - "macie2:GetMacieSession"
                  - "s3:GetAccountPublicAccessBlock"
                  - "shield:DescribeProtection"
                  - "shield:GetSubscriptionState"
                  - "securityhub:BatchImportFindings"
                  - "securityhub:GetFindings"
                  - "ssm:GetDocument"
                  - "ssm-incidents:List*"
                  - "support:Describe*"
                  - "tag:GetTagKeys"
                  - "wellarchitected:List*"
                Resource: "*"
        - PolicyName: ProwlerScanRoleAdditionalViewPrivilegesApiGateway
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "apigateway:GET"
                Resource: "arn:aws:apigateway:*::/restapis/*"
        - PolicyName: ProwlerS3BucketPutObject
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:PutObject"
                  - "s3:PutObjectAcl"
                Resource: !Sub "arn:aws:s3:::${ProwlerBucket}/*"
      Tags:
        - Key: Name
          Value: ProTOD Prowler Role

# The output is shown only if pCreateProwlerS3Bucket is true
Outputs:
  ProwlerS3Bucket:
    Condition: CreateProwlerS3Bucket
    Description: S3 Bucket for Prowler output files
    Value: !Ref ProwlerBucket
    Export:
      Name: "ProwlerS3Bucket"
